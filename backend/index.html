<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détection de Somnolence - DrowsWatch</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
        }

        .video-container {
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        #videoElement {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
        }

        .status-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .status-awake {
            background: rgba(39, 174, 96, 0.9);
            color: white;
        }

        .status-drowsy {
            background: rgba(231, 76, 60, 0.9);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .control-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-start {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .btn-stop {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .stats-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stats-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .history-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .session-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary-color);
            transition: all 0.3s ease;
        }

        .session-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .audio-control {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .navbar-custom {
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.95), rgba(52, 73, 94, 0.95));
            backdrop-filter: blur(10px);
            border-radius: 0 0 20px 20px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .alert-custom {
            border-radius: 15px;
            border: none;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
            }
            
            .control-panel {
                padding: 15px;
            }
            
            .stats-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-eye me-2"></i>DrowsWatch
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#detection">Détection</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#history">Historique</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#settings">Paramètres</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-container">
            <!-- Section de détection -->
            <div id="detection" class="p-4">
                <h2 class="text-center mb-4 fw-bold text-primary">
                    <i class="fas fa-video me-2"></i>Surveillance en Temps Réel
                </h2>
                
                <!-- Conteneur vidéo -->
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="video-container">
                            <video id="videoElement" autoplay muted playsinline></video>
                            <div class="status-overlay">
                                <div id="statusBadge" class="status-badge status-awake">
                                    <i class="fas fa-eye me-2"></i>Éveillé
                                </div>
                                <div id="confidenceBadge" class="status-badge" style="background: rgba(52, 152, 219, 0.9); color: white;">
                                    Confiance: 0%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panneau de contrôle -->
                <div class="control-panel">
                    <div class="row align-items-center">
                        <div class="col-md-6 text-center mb-3 mb-md-0">
                            <button id="startBtn" class="btn btn-custom btn-start me-3">
                                <i class="fas fa-play me-2"></i>Démarrer
                            </button>
                            <button id="stopBtn" class="btn btn-custom btn-stop" disabled>
                                <i class="fas fa-stop me-2"></i>Arrêter
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-around">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Durée: <span id="sessionDuration">00:00</span>
                                </small>
                                <small class="text-muted">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Alertes: <span id="alertCount">0</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistiques en temps réel -->
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <div class="stats-card">
                            <div class="stats-number" id="frameCount">0</div>
                            <div class="stats-label">Frames analysées</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stats-card">
                            <div class="stats-number text-success" id="awakeCount">0</div>
                            <div class="stats-label">Détections éveillé</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stats-card">
                            <div class="stats-number text-danger" id="drowsyCount">0</div>
                            <div class="stats-label">Détections somnolent</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stats-card">
                            <div class="stats-number text-warning" id="avgConfidence">0%</div>
                            <div class="stats-label">Confiance moyenne</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section de paramètres audio -->
            <div id="settings" class="audio-control">
                <h4 class="mb-3 fw-bold text-primary">
                    <i class="fas fa-volume-up me-2"></i>Paramètres Audio
                </h4>
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Sonnerie d'alerte personnalisée</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="audioFile" class="file-input" accept="audio/*">
                            <button class="file-input-button">
                                <i class="fas fa-upload me-2"></i>Choisir un fichier audio
                            </button>
                        </div>
                        <small class="text-muted mt-2 d-block">Formats supportés: MP3, WAV, OGG</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Sonneries prédéfinies</label>
                        <select id="predefinedAlert" class="form-select">
                            <option value="">Choisir une sonnerie</option>
                            <option value="beep">Bip standard</option>
                            <option value="alarm">Alarme</option>
                            <option value="bell">Cloche</option>
                            <option value="whistle">Sifflet</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button id="testAudioBtn" class="btn btn-outline-primary w-100">
                            <i class="fas fa-play me-2"></i>Tester le son
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <label class="form-label me-3 mb-0">Volume:</label>
                            <input type="range" id="volumeSlider" class="form-range" min="0" max="100" value="70">
                            <span id="volumeValue" class="ms-2 fw-bold">70%</span>
                        </div>
                    </div>
                </div>
                <div id="audioFileName" class="alert alert-info mt-3" style="display: none;">
                    <i class="fas fa-music me-2"></i>
                    Fichier sélectionné: <span id="fileName"></span>
                </div>
            </div>

            <!-- Section historique -->
            <div id="history" class="history-section">
                <h3 class="mb-4 fw-bold text-primary">
                    <i class="fas fa-history me-2"></i>Historique des Sessions
                </h3>
                
                <div class="loading-spinner" id="historyLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-2 text-muted">Chargement de l'historique...</p>
                </div>

                <div id="historyContainer">
                    <!-- Les sessions seront chargées dynamiquement -->
                </div>

                <div class="text-center mt-4">
                    <button id="clearHistoryBtn" class="btn btn-outline-danger">
                        <i class="fas fa-trash me-2"></i>Effacer l'historique
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio elements pour les alertes -->
    <audio id="alertAudio" preload="auto"></audio>
    <audio id="predefinedAudio" preload="auto"></audio>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        class DrowsinessDetector {
            constructor() {
                this.isRunning = false;
                this.videoElement = document.getElementById('videoElement');
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.statusBadge = document.getElementById('statusBadge');
                this.confidenceBadge = document.getElementById('confidenceBadge');
                this.alertAudio = document.getElementById('alertAudio');
                this.predefinedAudio = document.getElementById('predefinedAudio');
                
                // Variables de session
                this.sessionStartTime = null;
                this.frameCount = 0;
                this.awakeCount = 0;
                this.drowsyCount = 0;
                this.alertCount = 0;
                this.confidenceSum = 0;
                this.consecutiveDrowsyFrames = 0;
                
                // Variables audio
                this.customAudioFile = null;
                this.currentVolume = 0.7;
                
                this.initializeEventListeners();
                this.loadPredefinedSounds();
                this.loadHistory();
            }

            initializeEventListeners() {
                this.startBtn.addEventListener('click', () => this.startDetection());
                this.stopBtn.addEventListener('click', () => this.stopDetection());
                
                // Gestion des fichiers audio
                document.getElementById('audioFile').addEventListener('change', (e) => this.handleAudioFile(e));
                document.getElementById('predefinedAlert').addEventListener('change', (e) => this.selectPredefinedAlert(e));
                document.getElementById('testAudioBtn').addEventListener('click', () => this.testAudio());
                document.getElementById('volumeSlider').addEventListener('input', (e) => this.updateVolume(e));
                document.getElementById('clearHistoryBtn').addEventListener('click', () => this.clearHistory());
            }

            loadPredefinedSounds() {
                // Charger les sons prédéfinis (simulation avec des tonalités)
                this.predefinedSounds = {
                    'beep': this.generateBeepSound(),
                    'alarm': this.generateAlarmSound(),
                    'bell': this.generateBellSound(),
                    'whistle': this.generateWhistleSound()
                };
            }

            generateBeepSound() {
                // Simulation d'un bip avec l'API Web Audio
                return () => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(this.currentVolume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.5);
                };
            }

            generateAlarmSound() {
                return () => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(this.currentVolume, audioContext.currentTime);
                    
                    // Pattern d'alarme
                    for (let i = 0; i < 3; i++) {
                        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + i * 0.3);
                        oscillator.frequency.setValueAtTime(1500, audioContext.currentTime + i * 0.3 + 0.15);
                    }
                    
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 1);
                };
            }

            generateBellSound() {
                return () => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // Do
                    gainNode.gain.setValueAtTime(this.currentVolume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 2);
                };
            }

            generateWhistleSound() {
                return () => {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(2000, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(3000, audioContext.currentTime + 0.1);
                    oscillator.frequency.exponentialRampToValueAtTime(2000, audioContext.currentTime + 0.3);
                    
                    gainNode.gain.setValueAtTime(this.currentVolume, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                };
            }

            async startDetection() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        } 
                    });
                    
                    this.videoElement.srcObject = stream;
                    this.isRunning = true;
                    this.sessionStartTime = new Date();
                    
                    // Reset des statistiques
                    this.frameCount = 0;
                    this.awakeCount = 0;
                    this.drowsyCount = 0;
                    this.alertCount = 0;
                    this.confidenceSum = 0;
                    this.consecutiveDrowsyFrames = 0;
                    
                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    
                    this.startProcessing();
                    this.startTimer();
                    
                    this.showAlert('Détection démarrée avec succès!', 'success');
                } catch (error) {
                    console.error('Erreur lors de l\'accès à la caméra:', error);
                    this.showAlert('Impossible d\'accéder à la caméra. Vérifiez les permissions.', 'danger');
                }
            }

            stopDetection() {
                this.isRunning = false;
                
                if (this.videoElement.srcObject) {
                    const tracks = this.videoElement.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                    this.videoElement.srcObject = null;
                }
                
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                
                this.saveSession();
                this.showAlert('Session terminée et sauvegardée!', 'info');
            }

            startProcessing() {
                if (!this.isRunning) return;
                
                // Simulation du traitement d'image (à remplacer par l'appel à l'API Flask)
                const imageData = this.captureFrame();
                this.processFrameWithAPI(imageData);

                
                setTimeout(() => this.startProcessing(), 100); // ~10 FPS
            }

            async processFrame() {
                // Simulation d'une détection (à remplacer par l'appel réel à l'API)
                const isDrowsy = Math.random() < 0.15; // 15% de chance d'être somnolent
                const confidence = Math.random() * 100;
                
                this.frameCount++;
                this.confidenceSum += confidence;
                
                if (isDrowsy) {
                    this.drowsyCount++;
                    this.consecutiveDrowsyFrames++;
                    this.updateStatus('drowsy', confidence);
                    
                    // Déclencher l'alerte après 5 frames consécutives
                    if (this.consecutiveDrowsyFrames >= 5) {
                        this.triggerAlert();
                        this.consecutiveDrowsyFrames = 0; // Reset pour éviter les alertes répétées
                    }
                } else {
                    this.awakeCount++;
                    this.consecutiveDrowsyFrames = 0;
                    this.updateStatus('awake', confidence);
                }
                
                this.updateStats();
            }

            updateStatus(status, confidence) {
                if (status === 'drowsy') {
                    this.statusBadge.className = 'status-badge status-drowsy';
                    this.statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Somnolent';
                } else {
                    this.statusBadge.className = 'status-badge status-awake';
                    this.statusBadge.innerHTML = '<i class="fas fa-eye me-2"></i>Éveillé';
                }
                
                this.confidenceBadge.textContent = `Confiance: ${Math.round(confidence)}%`;
            }

            updateStats() {
                document.getElementById('frameCount').textContent = this.frameCount;
                document.getElementById('awakeCount').textContent = this.awakeCount;
                document.getElementById('drowsyCount').textContent = this.drowsyCount;
                document.getElementById('alertCount').textContent = this.alertCount;
                
                const avgConfidence = this.frameCount > 0 ? Math.round(this.confidenceSum / this.frameCount) : 0;
                document.getElementById('avgConfidence').textContent = `${avgConfidence}%`;
            }

            startTimer() {
                if (!this.isRunning) return;
                
                const now = new Date();
                const elapsed = Math.floor((now - this.sessionStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('sessionDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                setTimeout(() => this.startTimer(), 1000);
            }

            triggerAlert() {
                this.alertCount++;
                
                // Jouer le son d'alerte
                if (this.customAudioFile) {
                    this.alertAudio.volume = this.currentVolume;
                    this.alertAudio.play().catch(console.error);
                } else {
                    const selectedSound = document.getElementById('predefinedAlert').value;
                    if (selectedSound && this.predefinedSounds[selectedSound]) {
                        this.predefinedSounds[selectedSound]();
                    } else {
                        // Son par défaut
                        this.predefinedSounds['beep']();
                    }
                }
                
                // Vibration sur mobile
                if (navigator.vibrate) {
                    navigator.vibrate([500, 200, 500]);
                }
                
                this.showAlert('⚠️ ALERTE SOMNOLENCE DÉTECTÉE!', 'warning', 3000);
            }

            handleAudioFile(event) {
                const file = event.target.files[0];
                if (file) {
                    this.customAudioFile = file;
                    const url = URL.createObjectURL(file);
                    this.alertAudio.src = url;
                    
                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('audioFileName').style.display = 'block';
                    
                    // Désélectionner les sons prédéfinis
                    document.getElementById('predefinedAlert').value = '';
                }
            }

            selectPredefinedAlert(event) {
                const sound = event.target.value;
                if (sound) {
                    this.customAudioFile = null;
                    this.alertAudio.src = '';
                    document.getElementById('audioFileName').style.display = 'none';
                    document.getElementById('audioFile').value = '';
                }
            }

            testAudio() {
                if (this.customAudioFile) {
                    this.alertAudio.volume = this.currentVolume;
                    this.alertAudio.play().catch(console.error);
                } else {
                    const selectedSound = document.getElementById('predefinedAlert').value || 'beep';
                    if (this.predefinedSounds[selectedSound]) {
                        this.predefinedSounds[selectedSound]();
                    }
                }
            }

            updateVolume(event) {
                this.currentVolume = event.target.value / 100;
                document.getElementById('volumeValue').textContent = `${event.target.value}%`;
                this.alertAudio.volume = this.currentVolume;
            }

            saveSession() {
                if (!this.sessionStartTime) return;
                
                const endTime = new Date();
                const duration = Math.floor((endTime - this.sessionStartTime) / 1000);
                const avgConfidence = this.frameCount > 0 ? Math.round(this.confidenceSum / this.frameCount) : 0;
                
                const session = {
                    id: Date.now(),
                    startTime: this.sessionStartTime.toISOString(),
                    endTime: endTime.toISOString(),
                    duration: duration,
                    frameCount: this.frameCount,
                    awakeCount: this.awakeCount,
                    drowsyCount: this.drowsyCount,
                    alertCount: this.alertCount,
                    avgConfidence: avgConfidence,
                    drowsyPercentage: this.frameCount > 0 ? Math.round((this.drowsyCount / this.frameCount) * 100) : 0
                };
                
                // Sauvegarder en mémoire (à remplacer par un appel API)
                let sessions = this.getSessions();
                sessions.unshift(session);
                
                // Garder seulement les 50 dernières sessions
                if (sessions.length > 50) {
                    sessions = sessions.slice(0, 50);
                }
                
                // Simulation de sauvegarde (en production, appeler l'API Flask)
                this.saveSessions(sessions);
                this.loadHistory();
            }

            getSessions() {
                // En production, remplacer par un appel à l'API Flask
                const stored = sessionStorage.getItem('drowsiness_sessions');
                return stored ? JSON.parse(stored) : [];
            }

            saveSessions(sessions) {
                // En production, remplacer par un appel à l'API Flask
                sessionStorage.setItem('drowsiness_sessions', JSON.stringify(sessions));
            }

            async loadHistory() {
                const historyContainer = document.getElementById('historyContainer');
                const loadingSpinner = document.getElementById('historyLoading');
                
                loadingSpinner.style.display = 'block';
                historyContainer.innerHTML = '';
                
                // Simulation d'un délai de chargement
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const sessions = this.getSessions();
                loadingSpinner.style.display = 'none';
                
                if (sessions.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Aucune session enregistrée</h5>
                            <p class="text-muted">Démarrez votre première session de détection!</p>
                        </div>
                    `;
                    return;
                }
                
                sessions.forEach(session => {
                    const sessionCard = this.createSessionCard(session);
                    historyContainer.appendChild(sessionCard);
                });
            }

            createSessionCard(session) {
                const card = document.createElement('div');
                card.className = 'session-card';
                
                const startTime = new Date(session.startTime);
                const duration = this.formatDuration(session.duration);
                const date = startTime.toLocaleDateString('fr-FR');
                const time = startTime.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                
                let statusClass = 'success';
                let statusText = 'Excellente vigilance';
                let statusIcon = 'check-circle';
                
                if (session.drowsyPercentage > 30) {
                    statusClass = 'danger';
                    statusText = 'Somnolence élevée';
                    statusIcon = 'exclamation-triangle';
                } else if (session.drowsyPercentage > 10) {
                    statusClass = 'warning';
                    statusText = 'Vigilance modérée';
                    statusIcon = 'exclamation-circle';
                }
                
                card.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <strong>${date} à ${time}</strong>
                                <span class="badge bg-${statusClass} ms-2">
                                    <i class="fas fa-${statusIcon} me-1"></i>${statusText}
                                </span>
                            </div>
                            <div class="row g-2 small text-muted">
                                <div class="col-6 col-md-3">
                                    <i class="fas fa-clock me-1"></i>
                                    Durée: ${duration}
                                </div>
                                <div class="col-6 col-md-3">
                                    <i class="fas fa-eye me-1"></i>
                                    Éveillé: ${session.awakeCount}
                                </div>
                                <div class="col-6 col-md-3">
                                    <i class="fas fa-tired me-1"></i>
                                    Somnolent: ${session.drowsyCount}
                                </div>
                                <div class="col-6 col-md-3">
                                    <i class="fas fa-bell me-1"></i>
                                    Alertes: ${session.alertCount}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-2 mt-md-0">
                            <div class="mb-2">
                                <small class="text-muted">Confiance moyenne</small>
                                <div class="fw-bold text-primary">${session.avgConfidence}%</div>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="app.viewSessionDetails(${session.id})">
                                    <i class="fas fa-eye me-1"></i>Détails
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="app.deleteSession(${session.id})">
                                    <i class="fas fa-trash me-1"></i>Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                return card;
            }

            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m ${secs}s`;
                } else if (minutes > 0) {
                    return `${minutes}m ${secs}s`;
                } else {
                    return `${secs}s`;
                }
            }

            viewSessionDetails(sessionId) {
                const sessions = this.getSessions();
                const session = sessions.find(s => s.id === sessionId);
                
                if (!session) return;
                
                const startTime = new Date(session.startTime);
                const endTime = new Date(session.endTime);
                
                const modalContent = `
                    <div class="modal fade" id="sessionModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-chart-line me-2"></i>Détails de la Session
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <div class="card border-0 bg-light">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-play-circle fa-2x text-success mb-2"></i>
                                                    <h6>Début de session</h6>
                                                    <p class="mb-0">${startTime.toLocaleString('fr-FR')}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card border-0 bg-light">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-stop-circle fa-2x text-danger mb-2"></i>
                                                    <h6>Fin de session</h6>
                                                    <p class="mb-0">${endTime.toLocaleString('fr-FR')}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row g-3">
                                        <div class="col-md-3 col-6">
                                            <div class="text-center">
                                                <div class="display-6 fw-bold text-primary">${this.formatDuration(session.duration)}</div>
                                                <small class="text-muted">Durée totale</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <div class="text-center">
                                                <div class="display-6 fw-bold text-info">${session.frameCount}</div>
                                                <small class="text-muted">Frames analysées</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <div class="text-center">
                                                <div class="display-6 fw-bold text-success">${session.awakeCount}</div>
                                                <small class="text-muted">Détections éveillé</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <div class="text-center">
                                                <div class="display-6 fw-bold text-danger">${session.drowsyCount}</div>
                                                <small class="text-muted">Détections somnolent</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <hr class="my-4">
                                    
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <div class="h3 text-warning">${session.alertCount}</div>
                                                <small class="text-muted">Alertes déclenchées</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <div class="h3 text-info">${session.avgConfidence}%</div>
                                                <small class="text-muted">Confiance moyenne</small>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="text-center">
                                                <div class="h3 text-primary">${session.drowsyPercentage}%</div>
                                                <small class="text-muted">% Somnolence</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                                    <button type="button" class="btn btn-danger" onclick="app.deleteSession(${session.id}); bootstrap.Modal.getInstance(document.getElementById('sessionModal')).hide();">
                                        <i class="fas fa-trash me-2"></i>Supprimer cette session
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Supprimer le modal existant s'il y en a un
                const existingModal = document.getElementById('sessionModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Ajouter le nouveau modal
                document.body.insertAdjacentHTML('beforeend', modalContent);
                const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
                modal.show();
            }

            deleteSession(sessionId) {
                if (!confirm('Êtes-vous sûr de vouloir supprimer cette session?')) {
                    return;
                }
                
                let sessions = this.getSessions();
                sessions = sessions.filter(s => s.id !== sessionId);
                this.saveSessions(sessions);
                this.loadHistory();
                
                this.showAlert('Session supprimée avec succès!', 'success');
            }

            clearHistory() {
                if (!confirm('Êtes-vous sûr de vouloir effacer tout l\'historique? Cette action est irréversible.')) {
                    return;
                }
                
                this.saveSessions([]);
                this.loadHistory();
                this.showAlert('Historique effacé avec succès!', 'success');
            }

            showAlert(message, type = 'info', duration = 5000) {
                const alertContainer = document.createElement('div');
                alertContainer.className = `alert alert-${type} alert-dismissible fade show alert-custom position-fixed`;
                alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
                
                let icon = 'info-circle';
                switch(type) {
                    case 'success': icon = 'check-circle'; break;
                    case 'danger': icon = 'exclamation-triangle'; break;
                    case 'warning': icon = 'exclamation-circle'; break;
                }
                
                alertContainer.innerHTML = `
                    <i class="fas fa-${icon} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alertContainer);
                
                // Auto-dismiss après la durée spécifiée
                setTimeout(() => {
                    if (alertContainer.parentNode) {
                        alertContainer.classList.remove('show');
                        setTimeout(() => {
                            if (alertContainer.parentNode) {
                                alertContainer.remove();
                            }
                        }, 150);
                    }
                }, duration);
            }

            // Méthode pour intégrer avec l'API Flask (à implémenter)
            async callFlaskAPI(endpoint, data = null) {
                const baseURL = 'http://localhost:5000'; // À adapter selon votre configuration
                
                try {
                    const options = {
                        method: data ? 'POST' : 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    };
                    
                    if (data) {
                        options.body = JSON.stringify(data);
                    }
                    
                    const response = await fetch(`${baseURL}${endpoint}`, options);
                    return await response.json();
                } catch (error) {
                    console.error('Erreur API:', error);
                    this.showAlert('Erreur de connexion avec le serveur', 'danger');
                    return null;
                }
            }

            // Méthode pour traiter une frame avec l'API Flask
            async processFrameWithAPI(imageData) {
                const result = await this.callFlaskAPI('/predict', { image: imageData });
                
                if (result) {
                    const isDrowsy = result.prediction === 'drowsy';
                    const confidence = result.confidence;
                    
                    this.frameCount++;
                    this.confidenceSum += confidence;
                    
                    if (isDrowsy) {
                        this.drowsyCount++;
                        this.consecutiveDrowsyFrames++;
                        this.updateStatus('drowsy', confidence);
                        
                        if (this.consecutiveDrowsyFrames >= 5) {
                            this.triggerAlert();
                            this.consecutiveDrowsyFrames = 0;
                        }
                    } else {
                        this.awakeCount++;
                        this.consecutiveDrowsyFrames = 0;
                        this.updateStatus('awake', confidence);
                    }
                    
                    this.updateStats();
                }
            }

            // Méthode pour capturer une frame de la vidéo
            captureFrame() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = this.videoElement.videoWidth;
                canvas.height = this.videoElement.videoHeight;
                
                ctx.drawImage(this.videoElement, 0, 0);
                
                return canvas.toDataURL('image/jpeg', 0.8);
            }
        }

        // Initialisation de l'application
        let app;
        document.addEventListener('DOMContentLoaded', function() {
            app = new DrowsinessDetector();
            
            // Smooth scrolling pour la navigation
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        });

        // Gestion des erreurs non capturées
        window.addEventListener('error', function(e) {
            console.error('Erreur JavaScript:', e.error);
            if (app) {
                app.showAlert('Une erreur inattendue s\'est produite', 'danger');
            }
        });

        // Gestion de la visibilité de la page (pause/reprise automatique)
        document.addEventListener('visibilitychange', function() {
            if (app && app.isRunning) {
                if (document.hidden) {
                    console.log('Page cachée - détection en pause');
                } else {
                    console.log('Page visible - détection reprise');
                }
            }
        });
    </script>
</body>
</html>